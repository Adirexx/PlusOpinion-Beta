<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - PlusOpinion | Secure Password Recovery</title>
    <meta name="description"
        content="Reset your PlusOpinion account password securely. Get instant access to your account with our secure password recovery system.">
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon for browser tabs -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D42E61TP4M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-D42E61TP4M');
    </script>

    <!-- Router for clean URLs -->
    <script src="/router.js"></script>
    <script>
        if (window.RouteCleaner) window.RouteCleaner.cleanCurrentUrl();
    </script>
    <!-- Professional Update & Maintenance System -->
    <script src="/updater.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            background-color: #020408;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2 {
            font-family: 'Space Grotesk', sans-serif;
        }

        .glass-card {
            background: rgba(20, 25, 35, 0.4);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Background Gradient -->
    <div class="fixed inset-0 -z-10">
        <div class="absolute top-0 left-0 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl"></div>
    </div>

    <!-- Reset Password Card -->
    <div class="w-full max-w-md glass-card p-8 rounded-3xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-white mb-2">Reset Password</h1>
            <p class="text-slate-400 text-sm">Enter your new password below</p>
        </div>

        <!-- Success Message (hidden by default) -->
        <div id="successMessage" class="hidden bg-green-500/10 border border-green-500/20 rounded-xl p-4 mb-6">
            <p class="text-green-400 font-bold mb-1">✓ Password Updated!</p>
            <p class="text-green-300 text-sm">Redirecting to login...</p>
        </div>

        <!-- Error Message (hidden by default) -->
        <div id="errorMessage" class="hidden bg-red-500/10 border border-red-500/20 rounded-xl p-4 mb-6">
            <p class="text-red-400 text-sm" id="errorText"></p>
        </div>

        <!-- Reset Form -->
        <form id="resetForm" class="space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-500 ml-2 mb-1 block uppercase">New Password <span
                        class="text-red-500">*</span></label>
                <input id="password" type="password" required minlength="6"
                    placeholder="Enter new password (min 6 characters)"
                    class="w-full bg-[#050a15] border border-white/10 px-6 py-4 rounded-2xl outline-none focus:border-blue-500/50 text-white text-sm transition-all" />
            </div>

            <div>
                <label class="text-xs font-bold text-slate-500 ml-2 mb-1 block uppercase">Confirm Password <span
                        class="text-red-500">*</span></label>
                <input id="confirmPassword" type="password" required minlength="6" placeholder="Re-enter new password"
                    class="w-full bg-[#050a15] border border-white/10 px-6 py-4 rounded-2xl outline-none focus:border-blue-500/50 text-white text-sm transition-all" />
            </div>

            <button type="submit" id="submitBtn"
                class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-2xl font-bold tracking-wide transition-all shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                UPDATE PASSWORD
            </button>
        </form>

        <div class="mt-6 text-center">
            <a href="/index.html" class="text-blue-400 hover:text-blue-300 text-sm">← Back to Login</a>
        </div>
    </div>

    <!-- Supabase UMD bundle (required for supabase.js to initialize window.supabase) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <!-- Shared proxy-aware Supabase client — DO NOT create a separate client in this page -->
    <script type="module" src="/supabase.js"></script>

    <script>
        // Wait for the shared supabase client (from supabase.js) to be available
        async function waitForSupabase(maxWait = 5000) {
            const start = Date.now();
            while (!window.supabase && (Date.now() - start) < maxWait) {
                await new Promise(r => setTimeout(r, 50));
            }
            return window.supabase;
        }

        // Get DOM elements
        const form = document.getElementById('resetForm');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const submitBtn = document.getElementById('submitBtn');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const successMessage = document.getElementById('successMessage');

        // Show error message
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        // Show success message
        function showSuccess() {
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            form.classList.add('hidden');
        }

        (async () => {
            const supabase = await waitForSupabase();
            if (!supabase) {
                showError('Failed to initialize. Please refresh the page.');
                submitBtn.disabled = true;
                return;
            }

            // Check if we have an access token in the URL (from magic link)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');

            console.log('[ResetPwd] Page loaded');
            console.log('[ResetPwd] Token type:', type);
            console.log('[ResetPwd] Has access token:', !!accessToken);

            // If no token, show error
            if (!accessToken || type !== 'recovery') {
                showError('Invalid or expired reset link. Please request a new password reset.');
                submitBtn.disabled = true;
                return;
            }

            // Set the session from the URL token so updateUser works
            const { error: sessionError } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: hashParams.get('refresh_token') || ''
            });
            if (sessionError) {
                console.warn('[ResetPwd] Session set warning (may be benign):', sessionError.message);
            }

            // Handle form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (password !== confirmPassword) {
                    showError('Passwords do not match!');
                    return;
                }

                if (password.length < 6) {
                    showError('Password must be at least 6 characters long!');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'UPDATING...';

                try {
                    console.log('[ResetPwd] Attempting to update password via proxy...');

                    const { data, error } = await supabase.auth.updateUser({ password });

                    if (error) {
                        console.error('[ResetPwd] Password update error:', error);
                        throw error;
                    }

                    console.log('[ResetPwd] Password updated successfully:', data);
                    showSuccess();

                    await supabase.auth.signOut();

                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 2000);

                } catch (error) {
                    console.error('[ResetPwd] Error updating password:', error);
                    showError(error.message || 'Failed to update password. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'UPDATE PASSWORD';
                }
            });
        })();
    </script>
</body>

</html>
